<!-- src/app/features/transactions/transfer/transfer.html -->
<div class="transaction-container">
  <!-- Back Button -->
  <div class="page-back">
    <button mat-button routerLink="/dashboard" class="back-btn">
      <mat-icon>arrow_back</mat-icon>
      <span>Retour</span>
    </button>
  </div>

  <mat-card class="transfer-card">
    <!-- Header avec gradient -->
    <mat-card-header class="card-header">
      <div class="header-icon">
        <mat-icon>send</mat-icon>
      </div>
      <mat-card-title>Effectuer un transfert</mat-card-title>
      <mat-card-subtitle>Envoyez de l'argent dans toute l'Afrique de l'Ouest</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Info box transfert international -->
      @if (isInternational()) {
        <div class="info-box international">
          <mat-icon class="info-icon">public</mat-icon>
          <div class="info-content">
            <p class="info-title">Transfert International</p>
            <p class="info-text">Des frais supplémentaires peuvent s'appliquer pour les transferts vers d'autres pays.</p>
          </div>
        </div>
      }

      <!-- Messages d'erreur et succès -->
      @if (error()) {
        <div class="message-box error-message">
          <mat-icon>error</mat-icon>
          <span>{{ error() }}</span>
        </div>
      }

      @if (success()) {
        <div class="message-box success-message">
          <mat-icon>check_circle</mat-icon>
          <span>{{ success() }}</span>
        </div>
      }

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="transfer-form">
        <!-- Sélection du pays destinataire -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>location_on</mat-icon>
            Pays du destinataire
          </h3>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Pays</mat-label>
            <mat-select formControlName="paysDestinataire" panelClass="country-panel">
              @if (loadingCountries()) {
                <mat-option disabled>Chargement...</mat-option>
              } @else {
                @for (country of countries(); track country.code) {
                  <mat-option [value]="country.code">
                    <span class="country-option">
                      <span class="country-flag">{{ getCountryFlag(country.code) }}</span>
                      <span class="country-name">{{ country.nom }}</span>
                      <span class="country-dial">{{ country.indicatif }}</span>
                    </span>
                  </mat-option>
                }
              }
            </mat-select>
            <mat-icon matPrefix>flag</mat-icon>
          </mat-form-field>
        </div>

        <!-- Numéro de téléphone -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>person</mat-icon>
            Destinataire
          </h3>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Numéro de téléphone</mat-label>
            <input 
              matInput 
              type="tel" 
              formControlName="telephone" 
              [placeholder]="phonePlaceholder()"
              inputmode="numeric"
            />
            <mat-icon matPrefix>phone</mat-icon>
            @if (validatingRecipient()) {
              <mat-spinner matSuffix diameter="20"></mat-spinner>
            } @else if (recipientInfo()) {
              <mat-icon matSuffix class="valid-icon">check_circle</mat-icon>
            }
            <mat-hint>{{ phoneHint() }}</mat-hint>
            @if (form.get('telephone')?.hasError('required') && form.get('telephone')?.touched) {
              <mat-error>Le numéro de téléphone est requis</mat-error>
            }
          </mat-form-field>

          <!-- Info destinataire validé -->
          @if (recipientInfo()) {
            <div class="recipient-info">
              <mat-icon>verified_user</mat-icon>
              <div class="recipient-details">
                <span class="recipient-name">{{ recipientInfo()?.nomComplet }}</span>
                <span class="recipient-phone">{{ recipientInfo()?.telephone }}</span>
              </div>
            </div>
          }

          <!-- Erreur destinataire -->
          @if (recipientError()) {
            <div class="recipient-error">
              <mat-icon>warning</mat-icon>
              <span>{{ recipientError() }}</span>
            </div>
          }
        </div>

        <!-- Montant -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>payments</mat-icon>
            Montant
          </h3>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Montant à transférer</mat-label>
            <input 
              matInput 
              type="number" 
              formControlName="montant" 
              min="100"
            />
            <mat-icon matPrefix>attach_money</mat-icon>
            <span matTextSuffix>{{ selectedCountry()?.symbole || 'FCFA' }}</span>
            <mat-hint>Minimum: 100 {{ selectedCountry()?.symbole || 'FCFA' }}</mat-hint>
            @if (form.get('montant')?.hasError('required') && form.get('montant')?.touched) {
              <mat-error>Le montant est requis</mat-error>
            }
            @if (form.get('montant')?.hasError('min')) {
              <mat-error>Montant minimum: 100 {{ selectedCountry()?.symbole || 'FCFA' }}</mat-error>
            }
          </mat-form-field>

          <!-- Récapitulatif des frais -->
          @if (fees()) {
            <div class="fees-summary" [class.international]="fees()?.estInternational">
              <div class="fees-header">
                <mat-icon>receipt</mat-icon>
                <span>Récapitulatif</span>
                @if (calculatingFees()) {
                  <mat-spinner diameter="16"></mat-spinner>
                }
              </div>
              <mat-divider></mat-divider>
              <div class="fees-rows">
                <div class="fees-row">
                  <span>Montant envoyé</span>
                  <span>{{ form.get('montant')?.value | currencyXOF }}</span>
                </div>
                <div class="fees-row">
                  <span>Frais ({{ fees()?.tauxFrais }}%)</span>
                  <span class="fees-amount">{{ fees()?.frais | currencyXOF }}</span>
                </div>
                <mat-divider></mat-divider>
                <div class="fees-row total">
                  <span>Total débité</span>
                  <span>{{ fees()?.montantTotal | currencyXOF }}</span>
                </div>
              </div>
              @if (fees()?.estInternational) {
                <div class="fees-note">
                  <mat-icon>info</mat-icon>
                  <span>Frais majorés pour transfert international</span>
                </div>
              }
            </div>
          }
        </div>

        <!-- Description optionnelle -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description (optionnel)</mat-label>
          <input 
            matInput 
            formControlName="description" 
            placeholder="Ex: Remboursement, Cadeau..."
          />
          <mat-icon matPrefix>notes</mat-icon>
        </mat-form-field>

        <!-- Code PIN -->
        <div class="form-section pin-section">
          <h3 class="section-title">
            <mat-icon>lock</mat-icon>
            Sécurité
          </h3>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Code PIN</mat-label>
            <input 
              matInput 
              type="password" 
              formControlName="pin" 
              placeholder="****" 
              maxlength="6"
              inputmode="numeric"
              autocomplete="off"
            />
            <mat-icon matPrefix>password</mat-icon>
            <mat-hint>4 à 6 chiffres</mat-hint>
            @if (form.get('pin')?.hasError('required') && form.get('pin')?.touched) {
              <mat-error>Le code PIN est requis</mat-error>
            }
            @if (form.get('pin')?.hasError('pattern')) {
              <mat-error>Chiffres uniquement</mat-error>
            }
            @if (form.get('pin')?.hasError('minlength')) {
              <mat-error>Minimum 4 chiffres</mat-error>
            }
          </mat-form-field>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button 
            mat-button 
            type="button" 
            routerLink="/dashboard" 
            class="cancel-btn"
          >
            <mat-icon>arrow_back</mat-icon>
            <span>Annuler</span>
          </button>
          
          <button 
            mat-raised-button 
            type="submit" 
            [disabled]="form.invalid || loading() || !recipientInfo()"
            class="submit-btn"
            [class.loading]="loading()"
          >
            @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Envoi en cours...</span>
            } @else {
              <ng-container>
                <mat-icon>send</mat-icon>
                <span>Envoyer {{ fees()?.montantTotal ? (fees()?.montantTotal | currencyXOF) : '' }}</span>
              </ng-container>
            }
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Bottom Navigation -->
  <app-bottom-nav></app-bottom-nav>
</div>