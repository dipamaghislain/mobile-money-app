<div class="register-container">
  <mat-card class="register-card" appearance="outlined">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="title-icon">account_circle</mat-icon>
        Créer un compte
      </mat-card-title>
      <mat-card-subtitle>Rejoignez Mobile Money aujourd'hui</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="card-content">
      <div class="form-scroll">
        <div *ngIf="serverError" class="error-message">
          <mat-icon>error</mat-icon>
          <span>{{ serverError }}</span>
        </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()" autocomplete="on">
          <!-- Nom / Prénom -->
          <div class="name-row">
            <mat-form-field appearance="outline" class="name-field">
              <mat-label>Prénom</mat-label>
              <mat-icon matPrefix>person</mat-icon>
              <input matInput type="text" formControlName="prenom" autocomplete="given-name" />
              <mat-error *ngIf="showError('prenom','required')">Prénom requis</mat-error>
              <mat-error *ngIf="showError('prenom','minlength')">Minimum 2 caractères</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="name-field">
              <mat-label>Nom</mat-label>
              <mat-icon matPrefix>badge</mat-icon>
              <input matInput type="text" formControlName="nom" autocomplete="family-name" />
              <mat-error *ngIf="showError('nom','required')">Nom requis</mat-error>
              <mat-error *ngIf="showError('nom','minlength')">Minimum 2 caractères</mat-error>
            </mat-form-field>
          </div>

          <!-- Email -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email</mat-label>
            <mat-icon matPrefix>mail</mat-icon>
            <input matInput type="email" formControlName="email" autocomplete="email" />

            <mat-error *ngIf="showError('email','required')">Email requis</mat-error>
            <mat-error *ngIf="showError('email','email')">Email invalide</mat-error>
          </mat-form-field>

          <!-- Pays + Téléphone -->
          <div class="phone-row">
            <mat-form-field appearance="outline" class="country-select">
              <mat-label>Pays</mat-label>
              <mat-select formControlName="country" panelClass="country-panel">
                <mat-option *ngFor="let c of countries" [value]="c.code">
                  {{ c.flag }} {{ c.name }} (+{{ c.dial }})
                </mat-option>
              </mat-select>
              <mat-hint>Choisis ton pays</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="phone-input">
              <mat-label>Numéro de téléphone</mat-label>
              <mat-icon matPrefix>phone</mat-icon>
              <span matTextPrefix class="dial-prefix">+{{ selectedCountry?.dial }}&nbsp;</span>

              <input matInput formControlName="phone" [placeholder]="phonePlaceholder" inputmode="numeric"
                autocomplete="tel" />

              <mat-hint>{{ phoneHint }}</mat-hint>
              <mat-error *ngIf="showError('phone','required')">Numéro requis</mat-error>
              <mat-error *ngIf="showError('phone','digitsOnly')">Chiffres uniquement</mat-error>
              <mat-error *ngIf="showError('phone','invalidPhone')">Numéro invalide pour le pays sélectionné</mat-error>
            </mat-form-field>
          </div>

          <!-- Type de compte -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Type de compte</mat-label>
            <mat-icon matPrefix>badge</mat-icon>
            <mat-select formControlName="accountType">
              <mat-option value="client">Client</mat-option>
              <mat-option value="marchand">Marchand</mat-option>
            </mat-select>
            <mat-error *ngIf="showError('accountType','required')">Type requis</mat-error>
          </mat-form-field>

          <!-- Mot de passe -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Mot de passe</mat-label>
            <mat-icon matPrefix>lock</mat-icon>

            <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password"
              autocomplete="new-password" />

            <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword"
              [attr.aria-label]="hidePassword ? 'Afficher le mot de passe' : 'Masquer le mot de passe'">
              <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>

            <mat-hint>Minimum 8 caractères</mat-hint>
            <mat-error *ngIf="showError('password','required')">Mot de passe requis</mat-error>
            <mat-error *ngIf="showError('password','minlength')">Minimum 8 caractères</mat-error>
          </mat-form-field>

          <!-- Confirmer mot de passe -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Confirmer le mot de passe</mat-label>
            <mat-icon matPrefix>lock</mat-icon>

            <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword"
              autocomplete="new-password" />

            <button mat-icon-button matSuffix type="button" (click)="hideConfirmPassword = !hideConfirmPassword"
              [attr.aria-label]="hideConfirmPassword ? 'Afficher' : 'Masquer'">
              <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>

            <mat-error *ngIf="showError('confirmPassword','required')">Confirmation requise</mat-error>
            <mat-error
              *ngIf="form.hasError('passwordMismatch') && (form.get('confirmPassword')?.touched || form.get('confirmPassword')?.dirty)">
              Les mots de passe ne correspondent pas
            </mat-error>
          </mat-form-field>

          <!-- PIN -->
          <div class="pin-box">
            <div class="pin-info">
              <mat-icon>info</mat-icon>
              <div>
                <strong>Le code PIN protège vos transactions.</strong>
                <div class="muted">Ne le partagez jamais.</div>
              </div>
            </div>

            <mat-form-field appearance="outline" class="pin-field">
              <mat-label>Code PIN</mat-label>
              <mat-icon matPrefix>pin</mat-icon>

              <input matInput [type]="hidePin ? 'password' : 'text'" formControlName="pin" inputmode="numeric"
                maxlength="6" placeholder="4 à 6 chiffres" autocomplete="off" />

              <button mat-icon-button matSuffix type="button" (click)="hidePin = !hidePin"
                [attr.aria-label]="hidePin ? 'Afficher le PIN' : 'Masquer le PIN'">
                <mat-icon>{{ hidePin ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>

              <mat-error *ngIf="showError('pin','required')">PIN requis</mat-error>
              <mat-error *ngIf="showError('pin','digitsOnly')">Chiffres uniquement</mat-error>
              <mat-error *ngIf="showError('pin','pinLength')">PIN invalide (4 à 6 chiffres)</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="pin-field">
              <mat-label>Confirmer le PIN</mat-label>
              <mat-icon matPrefix>pin</mat-icon>

              <input matInput [type]="hideConfirmPin ? 'password' : 'text'" formControlName="confirmPin"
                inputmode="numeric" maxlength="6" placeholder="Répétez le PIN" autocomplete="off" />

              <button mat-icon-button matSuffix type="button" (click)="hideConfirmPin = !hideConfirmPin"
                [attr.aria-label]="hideConfirmPin ? 'Afficher' : 'Masquer'">
                <mat-icon>{{ hideConfirmPin ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>

              <mat-error *ngIf="showError('confirmPin','required')">Confirmation requise</mat-error>
              <mat-error
                *ngIf="form.hasError('pinMismatch') && (form.get('confirmPin')?.touched || form.get('confirmPin')?.dirty)">
                Les codes PIN ne correspondent pas
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Submit -->
          <button mat-flat-button color="primary" class="submit-btn" type="submit"
            [disabled]="form.invalid || submitting">
            <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
            <span *ngIf="!submitting">Créer le compte</span>
          </button>
        </form>
      </div>

      <div class="login-link">
        <p>Déjà un compte ? <a routerLink="/auth/login">Se connecter</a></p>
      </div>
    </mat-card-content>
  </mat-card>
</div>