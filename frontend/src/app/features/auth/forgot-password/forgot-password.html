<div class="auth-container">
  <mat-card class="auth-card">
    
    <!-- ===== ÉTAPE 1: EMAIL ===== -->
    @if (currentStep() === 'email') {
      <div class="card-header">
        <div class="header-icon">
          <mat-icon>lock_reset</mat-icon>
        </div>
        <h1 class="header-title">Mot de passe oublié ?</h1>
        <p class="header-subtitle">Entrez votre email pour recevoir un code de réinitialisation</p>
      </div>

      <mat-card-content>
        <div class="info-box">
          <mat-icon class="info-icon">info</mat-icon>
          <div class="info-content">
            <p class="info-title">Récupération de compte</p>
            <p class="info-text">Un code à 6 chiffres sera envoyé à votre adresse email.</p>
          </div>
        </div>

        <form [formGroup]="emailForm" (ngSubmit)="onSubmitEmail()">
          @if (error()) {
            <div class="message-box error-message">
              <mat-icon>error</mat-icon>
              <span>{{ error() }}</span>
            </div>
          }

          <div class="form-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Adresse email</mat-label>
              <input matInput type="email" formControlName="email" autocomplete="email">
              <mat-icon matPrefix>email</mat-icon>
              <mat-hint>Entrez l'email associé à votre compte</mat-hint>
              @if (emailForm.get('email')?.hasError('required')) {
                <mat-error>L'email est requis</mat-error>
              }
              @if (emailForm.get('email')?.hasError('email')) {
                <mat-error>Format d'email invalide</mat-error>
              }
            </mat-form-field>
          </div>

          <button mat-raised-button color="primary" class="submit-btn" type="submit"
            [disabled]="emailForm.invalid || loading()">
            @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Envoi en cours...</span>
            } @else {
              <ng-container>
                <mat-icon>send</mat-icon>
                <span>Envoyer le code</span>
              </ng-container>
            }
          </button>
        </form>

        <div class="auth-footer">
          <a routerLink="/auth/login" class="back-link">
            <mat-icon>arrow_back</mat-icon>
            <span>Retour à la connexion</span>
          </a>
        </div>
      </mat-card-content>
    }

    <!-- ===== ÉTAPE 2: CODE ===== -->
    @if (currentStep() === 'code') {
      <div class="card-header">
        <div class="header-icon code-icon">
          <mat-icon>pin</mat-icon>
        </div>
        <h1 class="header-title">Vérification</h1>
        <p class="header-subtitle">Entrez le code à 6 chiffres envoyé à {{ userEmail }}</p>
      </div>

      <mat-card-content>
        <!-- Code de développement -->
        @if (devCode()) {
          <div class="dev-code-box">
            <mat-icon>developer_mode</mat-icon>
            <div>
              <strong>Mode développement</strong>
              <p>Votre code: <span class="code-highlight">{{ devCode() }}</span></p>
            </div>
          </div>
        }

        <form [formGroup]="codeForm" (ngSubmit)="onSubmitCode()">
          @if (error()) {
            <div class="message-box error-message">
              <mat-icon>error</mat-icon>
              <span>{{ error() }}</span>
            </div>
          }

          <div class="form-section">
            <mat-form-field appearance="outline" class="full-width code-input">
              <mat-label>Code de vérification</mat-label>
              <input matInput type="text" formControlName="code" 
                     maxlength="6" inputmode="numeric" pattern="[0-9]*"
                     placeholder="000000" autocomplete="one-time-code">
              <mat-icon matPrefix>dialpad</mat-icon>
              <mat-hint>Code à 6 chiffres</mat-hint>
              @if (codeForm.get('code')?.hasError('required')) {
                <mat-error>Le code est requis</mat-error>
              }
              @if (codeForm.get('code')?.hasError('pattern')) {
                <mat-error>Le code doit contenir 6 chiffres</mat-error>
              }
            </mat-form-field>
          </div>

          <button mat-raised-button color="primary" class="submit-btn" type="submit"
            [disabled]="codeForm.invalid || loading()">
            @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Vérification...</span>
            } @else {
              <ng-container>
                <mat-icon>verified</mat-icon>
                <span>Vérifier le code</span>
              </ng-container>
            }
          </button>
        </form>

        <div class="resend-section">
          <p>Vous n'avez pas reçu le code ?</p>
          <button mat-button color="primary" (click)="resendCode()" [disabled]="loading()">
            <mat-icon>refresh</mat-icon>
            Renvoyer le code
          </button>
        </div>

        <div class="auth-footer">
          <button mat-button class="back-link" (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
            <span>Changer d'email</span>
          </button>
        </div>
      </mat-card-content>
    }

    <!-- ===== ÉTAPE 3: NOUVEAU MOT DE PASSE ===== -->
    @if (currentStep() === 'password') {
      <div class="card-header">
        <div class="header-icon password-icon">
          <mat-icon>lock</mat-icon>
        </div>
        <h1 class="header-title">Nouveau mot de passe</h1>
        <p class="header-subtitle">Créez un nouveau mot de passe sécurisé</p>
      </div>

      <mat-card-content>
        <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()">
          @if (error()) {
            <div class="message-box error-message">
              <mat-icon>error</mat-icon>
              <span>{{ error() }}</span>
            </div>
          }

          <div class="form-section">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Nouveau mot de passe</mat-label>
              <input matInput [type]="hidePassword() ? 'password' : 'text'" 
                     formControlName="nouveauMotDePasse" autocomplete="new-password">
              <mat-icon matPrefix>lock</mat-icon>
              <button mat-icon-button matSuffix type="button" (click)="togglePasswordVisibility()">
                <mat-icon>{{ hidePassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <mat-hint>Minimum 6 caractères</mat-hint>
              @if (passwordForm.get('nouveauMotDePasse')?.hasError('required')) {
                <mat-error>Le mot de passe est requis</mat-error>
              }
              @if (passwordForm.get('nouveauMotDePasse')?.hasError('minlength')) {
                <mat-error>Minimum 6 caractères</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Confirmer le mot de passe</mat-label>
              <input matInput [type]="hideConfirmPassword() ? 'password' : 'text'" 
                     formControlName="confirmMotDePasse" autocomplete="new-password">
              <mat-icon matPrefix>lock_outline</mat-icon>
              <button mat-icon-button matSuffix type="button" (click)="toggleConfirmPasswordVisibility()">
                <mat-icon>{{ hideConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              @if (passwordForm.get('confirmMotDePasse')?.hasError('required')) {
                <mat-error>Confirmez le mot de passe</mat-error>
              }
              @if (passwordForm.get('confirmMotDePasse')?.hasError('mismatch')) {
                <mat-error>Les mots de passe ne correspondent pas</mat-error>
              }
            </mat-form-field>
          </div>

          <button mat-raised-button color="primary" class="submit-btn" type="submit"
            [disabled]="passwordForm.invalid || loading()">
            @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
              <span>Réinitialisation...</span>
            } @else {
              <ng-container>
                <mat-icon>check_circle</mat-icon>
                <span>Réinitialiser</span>
              </ng-container>
            }
          </button>
        </form>

        <div class="auth-footer">
          <button mat-button class="back-link" (click)="goBack()">
            <mat-icon>arrow_back</mat-icon>
            <span>Retour</span>
          </button>
        </div>
      </mat-card-content>
    }

    <!-- ===== ÉTAPE 4: SUCCÈS ===== -->
    @if (currentStep() === 'success') {
      <div class="card-header success-header">
        <div class="header-icon success-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <h1 class="header-title">Mot de passe réinitialisé !</h1>
        <p class="header-subtitle">Vous pouvez maintenant vous connecter avec votre nouveau mot de passe</p>
      </div>

      <mat-card-content>
        <div class="success-content">
          <div class="success-illustration">
            <mat-icon>verified_user</mat-icon>
          </div>
          <p class="success-text">
            Votre mot de passe a été modifié avec succès. Pour des raisons de sécurité, 
            vous allez être redirigé vers la page de connexion.
          </p>
        </div>

        <button mat-raised-button color="primary" class="submit-btn" (click)="goToLogin()">
          <mat-icon>login</mat-icon>
          <span>Se connecter</span>
        </button>
      </mat-card-content>
    }

  </mat-card>

  <!-- Footer -->
  <p class="footer-text">© Mobile Money — Tous droits réservés</p>
</div>
